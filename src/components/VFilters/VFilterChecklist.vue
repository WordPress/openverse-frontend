<template>
  <fieldset class="mb-8">
    <legend v-if="title" class="text-sm font-semibold">
      {{ title }}
    </legend>
    <div
      v-for="(item, index) in options"
      :key="index"
      class="flex justify-between items-center mt-4"
    >
      <VCheckbox
        :id="item.code"
        :key="index"
        :checked="item.checked"
        :name="itemName"
        :value="item.code"
        :disabled="isDisabled(item)"
        @change="onValueChange"
      >
        <VLicense v-if="filterType === 'licenses'" :license="item.code" />
        <template v-else>{{ itemLabel(item) }}</template>
      </VCheckbox>

      <!-- License explanation -->
      <VPopover
        v-if="filterType === 'licenses'"
        :label="$t('browse-page.aria.license-explanation')"
      >
        <template #trigger="{ a11yProps }">
          <VButton
            v-bind="a11yProps"
            variant="plain"
            size="disabled"
            :aria-label="$t('browse-page.aria.license-explanation')"
            class="text-dark-charcoal-70"
            type="button"
          >
            <VIcon :icon-path="icons.help" />
          </VButton>
        </template>
        <template #default="{ close }">
          <div class="relative">
            <VIconButton
              :aria-label="getLicenseExplanationCloseAria(item.code)"
              class="absolute top-0 end-0 border-none text-dark-charcoal-70"
              size="small"
              :icon-props="{ iconPath: icons.closeSmall }"
              @click="close"
            />
            <VLicenseExplanation :license="item.code" />
          </div>
        </template>
      </VPopover>
    </div>
  </fieldset>
</template>

<script>
import { useSearchStore } from '~/stores/search'
import { getElements } from '~/utils/license'

import VLicenseExplanation from '~/components/VFilters/VLicenseExplanation.vue'
import VCheckbox from '~/components/VCheckbox/VCheckbox.vue'
import VLicense from '~/components/VLicense/VLicense.vue'
import VButton from '~/components/VButton.vue'
import VIcon from '~/components/VIcon/VIcon.vue'
import VIconButton from '~/components/VIconButton/VIconButton.vue'
import VPopover from '~/components/VPopover/VPopover.vue'

import helpIcon from '~/assets/icons/help.svg'
import closeSmallIcon from '~/assets/icons/close-small.svg'

export default {
  name: 'FilterCheckList',
  components: {
    VCheckbox,
    VButton,
    VIcon,
    VIconButton,
    VLicense,
    VLicenseExplanation,
    VPopover,
  },
  props: {
    options: { type: Array, required: false },
    title: { type: String },
    filterType: { type: String, required: true },
    disabled: { type: Boolean, default: false },
  },
  data() {
    return {
      icons: { help: helpIcon, closeSmall: closeSmallIcon },
    }
  },
  computed: {
    itemName() {
      return this.filterType === 'searchBy'
        ? this.$t('filters.search-by.title')
        : this.title
    },
  },
  methods: {
    itemLabel(item) {
      return ['audioProviders', 'imageProviders'].includes(this.filterType)
        ? item.name
        : this.$t(item.name)
    },
    onValueChange({ value }) {
      this.$emit('toggle-filter', {
        code: value,
        filterType: this.filterType,
      })
    },
    isDisabled(item) {
      return (
        useSearchStore().isFilterDisabled(item, this.filterType) ??
        this.disabled
      )
    },
    getLicenseExplanationCloseAria(license) {
      const elements = getElements(license).filter((icon) => icon !== 'cc')
      const descriptions = elements
        .map((element) => this.$t(`browse-page.license-description.${element}`))
        .join(' ')
      const close = this.$t('modal.close', {
        name: this.$t('browse-page.aria.license-explanation'),
      })
      return `${descriptions} - ${close}`
    },
  },
}
</script>
