<template>
  <div :aria-label="$t('photo-details.aria.main')" class="audio-page">
    <VAudioTrack :audio="audio" class="main-track" />
    <VMediaReuse
      data-testid="audio-attribution"
      :media="audio"
      class="my-16 px-4 md:px-0"
    />
    <VAudioDetails
      data-testid="audio-info"
      :audio="audio"
      class="my-16 px-4 lg:px-0"
    />
    <VRelatedAudio
      v-if="audio.id"
      class="my-16 px-4 lg:px-0"
      :audio-id="audio.id"
    />
  </div>
</template>

<script>
import { mapState } from 'vuex'
import { FETCH_AUDIO } from '~/constants/action-types'
import iframeHeight from '~/mixins/iframe-height'
import { AUDIO } from '~/constants/media'
import getAttributionHtml from '~/utils/attribution-html'
import { getFullLicenseName } from '~/utils/license'
import { MEDIA } from '~/constants/store-modules'

const AudioDetailPage = {
  name: 'AudioDetailPage',
  mixins: [iframeHeight],
  data() {
    return {
      thumbnailURL: null,
      breadCrumbURL: '',
      shouldShowBreadcrumb: false,
      id: null,
    }
  },
  computed: {
    ...mapState(MEDIA, ['audio']),
    fullLicenseName() {
      return getFullLicenseName(this.audio.license, this.audio.license_version)
    },
    licenseUrl() {
      return `${this.audio.license_url}?ref=openverse`
    },
  },
  watch: {
    audio(newAudio) {
      this.id = newAudio.id
    },
  },
  async asyncData({ env, store, route, error, app }) {
    try {
      await store.dispatch(`${MEDIA}/${FETCH_AUDIO}`, { id: route.params.id })
      return {
        thumbnailURL: `${env.apiUrl}audio/${route.params.id}/thumb/`,
        id: route.params.id,
      }
    } catch (err) {
      error({
        statusCode: 404,
        message: app.i18n.t('error.media-not-found', {
          mediaType: AUDIO,
          id: route.params.id,
        }),
      })
    }
  },
  beforeRouteEnter(to, from, nextPage) {
    nextPage((_this) => {
      if (from.path === '/search/' || from.path === '/search/audio') {
        _this.shouldShowBreadcrumb = true
        _this.breadCrumbURL = from.fullPath
      }
    })
  },
  methods: {
    attributionHtml() {
      const licenseUrl = `${this.licenseUrl}&atype=html`
      return getAttributionHtml(this.audio, licenseUrl, this.fullLicenseName)
    },
  },
  head() {
    const title = this.audio.title
    return {
      title: `${title} - ${this.$t('hero.brand')}`,
    }
  },
}

export default AudioDetailPage
</script>
<style>
.audio-page {
  --wp-max-width: 940px;
}
.audio-page section,
.audio-page aside {
  max-width: var(--wp-max-width);
  margin-right: auto;
  margin-left: auto;
}
.audio-page .full-track .mx-16 {
  @apply mt-6;
  @apply px-4 md:px-0;
  max-width: var(--wp-max-width);
  margin-right: auto;
  margin-left: auto;
}
</style>
